when:
  event:
    - push
    - pull_request
    - manual

steps:
  unit-tests:
    image: golang:1.25.1-alpine
    environment:
      CGO_ENABLED: "0"
    commands:
      - go test ./...

  coverage-tests:
    image: golang:1.25.1-alpine
    environment:
      CGO_ENABLED: "0"
    commands:
      - go test -cover ./...

  race-detection:
    image: golang:1.25.1-alpine
    environment:
      CGO_ENABLED: "1"
    commands:
      - apk add --no-cache gcc musl-dev
      - go test -race ./...

  specific-tests:
    image: golang:1.25.1-alpine
    environment:
      CGO_ENABLED: "0"
    commands:
      - go test -run TestChatComplete

  integration-test:
    image: golang:1.25.1-alpine
    environment:
      CGO_ENABLED: "0"
      ORAPIKEY:
        from_secret: openrouter_api_key
    commands:
      - go run cmd/openrouter-test/main.go -key $ORAPIKEY -test all -model "google/gemini-2.5-flash-lite"

  integration-test-analytics:
    image: golang:1.25.1-alpine
    environment:
      CGO_ENABLED: "0"
      ORPROVKEY:
        from_secret: openrouter_provisioning_key
    commands:
      - go run cmd/openrouter-test/main.go -key $ORPROVKEY -test activity
      - go run cmd/openrouter-test/main.go -key $ORPROVKEY -test key
      - go run cmd/openrouter-test/main.go -key $ORPROVKEY -test listkeys
      - go run cmd/openrouter-test/main.go -key $ORPROVKEY -test createkey
      - go run cmd/openrouter-test/main.go -key $ORPROVKEY -test updatekey
      - go run cmd/openrouter-test/main.go -key $ORPROVKEY -test deletekey

  discord-success-notification:
    image: appleboy/drone-discord
    settings:
      webhook_id:
        from_secret: discord_webhook_id
      webhook_token:
        from_secret: discord_webhook_token
      username: Woodpecker CI
      message: >
        ✅ **Build #{{build.number}} Succeeded**

        **Repository:** `{{repo.owner}}/{{repo.name}}` ({{build.branch}})

        **Event:** `{{uppercase build.event}}`

        **Commit:** [{{truncate build.commit 8}}]({{build.link}})

        **Author:** {{build.author}}

        **Message:** {{build.message}}

        **Duration:** {{since build.started}}

        **Finished:** {{datetime build.finished "2006-01-02 15:04:05" ""}}
    when:
      status: [success]
    failure: ignore

  discord-failure-notification:
    image: appleboy/drone-discord
    settings:
      webhook_id:
        from_secret: discord_webhook_id
      webhook_token:
        from_secret: discord_webhook_token
      username: Woodpecker CI
      message: >
        ❌ **Build #{{build.number}} Failed**

        **Repository:** `{{repo.owner}}/{{repo.name}}` ({{build.branch}})

        **Event:** `{{uppercase build.event}}`

        **Commit:** [{{truncate build.commit 8}}]({{build.link}})

        **Author:** {{build.author}}

        **Message:** {{build.message}}

        **Duration:** {{since build.started}}

        **Finished:** {{datetime build.finished "2006-01-02 15:04:05" ""}}
    when:
      status: [failure]
    failure: ignore
